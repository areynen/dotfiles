#!/bin/bash

# When shift is used
new_window=false

for arg in "$@"; do
    if [ "$arg" = "--new" ]; then
        new_window=true
    fi
done

#websites=$(grep -o '[^-]<a.*>' ~/.librewolf/homepage/index.html | grep -oP 'href="\K[^"]+|>([^<]+)' | sed 's/^>//' | awk 'NR%2{printf "%s ", $0; next} {print $0}')
websites=$(grep -o '<a.*/a>' ~/.librewolf/homepage/index.html | grep -oP 'href="\K[^"]+|>([^<]+)' | sed 's/^>//' | awk 'NR%2{printf "%s ", $0; next} {print $0}')

names=$(echo "$websites" | awk '{for (i=2; i<=NF; i++) printf "%s ", $i; print ""}' | sed 's/[[:space:]]*$//')

selected=$(echo "$names" | dmenu -i -p "Select or Search:")

# ESC
if [ -z "$selected" ]; then
    exit 0
fi

# Map name to url
url=$(echo "$websites" | grep "$selected" | head -1 | awk '{print $1}')

# Open in browser
if [ -n "$url" ]; then
    if [ "$new_window" = false ]; then
        $BROWSER --new-tab "$url"
    else
        $BROWSER --new-window "$url"
    fi
else

    if [ "$new_window" = false ]; then
        $BROWSER --new-tab "https://paulgo.io/search?q=$selected"
        #$BROWSER --new-tab "https://duckduckgo.com/?q=$selected"
    else
        $BROWSER --new-window "https://paulgo.io/search?q=$selected"
        #$BROWSER --new-window "https://duckduckgo.com/?q=$selected"
    fi
fi
